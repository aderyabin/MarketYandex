require 'hpricot'
require 'open-uri'
require 'json'
require 'rubygems'
require 'faster_csv'

class MarketYandex
  $KCODE = "utf-8"
  SEARCH_URL = 'http://market.yandex.ru/search.xml?cvredirect=1&text='
  SUGGEST_URL = 'http://suggest.market.yandex.ru/suggest-market?part='
  BASIC_URL = 'http://market.yandex.ru'
  @FILE_PATH = '/Users/aderyabin/Desktop/market/'

  attr_reader :name, :model_id, :image, :images, :thumb, :pricechart_thumb, :characteristics, :price, :currency

  #### ПОИСК ТОВАРОВ

  # Поиск товара по ключевому слову
  def self.search(product_name)
    product "#{SEARCH_URL}#{CGI.escape(product_name)}"
    @FILE_PATH = "/Users/aderyabin/Desktop/market/#{product_name.gsub(' ', "_")}.csv"
  end
  



  def self.get_content(url, hpricot = true, counter = 1)
    puts "counter start #{counter}"
    puts url.inspect
    begin
    data = open(url, "User-Agent" => "Ruby/#{RUBY_VERSION}",
    "From" => "foo@bar.invalid",
    "Referer" => "http://www.ruby-lang.org/")
  rescue
    puts '<===== invalid PROXY'
    data = get_content(url, false, counter+1)
  end
    puts "counter end #{counter}"
    data = Hpricot(data) if (true == hpricot)
    return data
  end


  # возвращает URL следующей страницы
  def self.next_page(data)    
    current_page = 0
    paginator_exists = data.search('div.b-pager__pages')
    return nil unless !paginator_exists.blank?
    res = Hash.new()
    current_page = paginator_exists.search('.b-pager__current').inner_html.to_i
    puts "PAGE = #{current_page}"
    paginator_exists.search('a').collect do |b|
      res[b.inner_html.to_i] = b["href"].gsub(/^\./,'')
    end
    if res[current_page+1]
      return full_url(res[current_page+1]) 
    else
      nil
    end
  end

  def self.full_url(raw_url)
    "#{BASIC_URL}/#{raw_url}"
  end
  # РАСШИРЕННЫЙ ПОИСК
  def self.suggest(product_name)
    @FILE_PATH = "/Users/aderyabin/Desktop/market/#{product_name.gsub(' ', "_")}.csv"
    uri = "#{SUGGEST_URL}#{CGI.escape(product_name)}"
    buffer = get_content(uri, false).read
    # convert JSON data into a array
    raw_urls = JSON.parse(buffer)[2].to_a
    result = Array.new
    # все товары, которые не бренды и не категории  
    raw_urls.each do |raw_url|
      doc = get_content(full_url(raw_url))
      result << parse_brand(doc) if brand?(doc)
      result << new(doc) if product?(doc)  
      result << parse_products(doc, true) if products?(doc)  
    end
    result.flatten.compact
  end 


  def self.products(url, paginate=false)
    doc = get_content(url)
    parse_products(doc, paginate)
  end


  # работа  с брендом 
  def self.brand(url)
    doc = Hpricot(open(url))
    if brand?(doc)
      parse_brand(doc)
    end
  end

  # по урлу ищет товар и его парсит его
  def self.product(url)
    if !product_link?(url)
      puts 'incorrect link'
      return
    end
    puts "parsing product: #{url.inspect}"
    doc = get_content(url)
    if product?(doc)
      res = new(doc)
      if @FILE_PATH
        puts 'WRITING TO FILE'
        FasterCSV.open(@FILE_PATH, "a+") do |csv|
          csv << [res.model_id, res.name, res.price, res.currency, res.thumb, res.pricechart_thumb, res.images.join(';'),res.characteristics.collect{|item| a = item.collect.flatten;"#{a[0]} = #{a[1]}"}.join(';') ]
          # :name, , :image, :images, :thumb, ::characteristics, 
        end        
      end
      res
    end
  end


  def initialize(doc)
    parse_product(doc)
  end

  def self.parse_products(doc, paginate=false)
    puts '*********** START PARSE PRODUCT PAGE  ***********'
    puts  doc.search('.b-offers__title a').collect{|a| a["href"].gsub(/^\./,'')}.inspect
    res = doc.search('.b-offers__title a').collect{|a| a["href"].gsub(/^\./,'')}.collect{|raw_url| product(full_url(raw_url))}
    if paginate 
      puts '*********** PAGINATE ENABLED ***********'
      next_url = next_page(doc)
      if next_url
        puts '*********** START PARSE PAGINATE ***********'
        res << products(next_url)
        puts '*********** END PARSE PAGINATE ***********'        
      else
        puts '*********** PAGINATE NOT FOUND ***********'
      end
    end
    puts '*********** END PARSE PRODUCT PAGE  ***********'
    res.flatten.uniq
  end

  def self.parse_brand(doc)
    table = doc.search('table.l-categories')
    table.search('dd').collect do |dd|
      {dd.inner_text => dd.search('a').collect{|a| a["href"]}.collect{|raw_url| product(full_url(raw_url))}}
    end
  end

  # Основная функция распознавания товара 
  def parse_product(doc)
    @name = doc.at("#global-model-name").inner_text
    @model_id = doc.at("/html/body/table[2]")["id"]
    @image = doc.at("td.bigpic a")['href'] if doc.at("td.bigpic a")
    @images = doc.search("td.smallpic a").collect{|a| a["href"]}
    @price = doc.at('div.price span.b-prices__num').inner_text.gsub(/\s/, '').gsub(/\302\240/, '').to_i rescue nil
    @currency = doc.at('div.price span.b-prices__currency').inner_text.gsub(/\s/, '').gsub(/\302\240/, '') rescue nil
    @thumb = doc.at("td.bigpic img")['src'] if doc.at("td.bigpic img")
    @pricechart_thumb = doc.at('div.pricesGraph img')['src'] if doc.at('div.pricesGraph img')
    @characteristics = parse_characteristics(doc)  
  end



  #### РАЗЛИЧНЫЕ ПРОВЕРКИ

  # страница товара?
  def self.product_link?(url)
    !url.to_s.include?('market-click2.yandex.ru')
  end

  # На странице один товар?
  def self.product?(doc)
    !!doc.at("#global-model-name")
  end


  # Страница бренда?
  def self.brand?(doc)
    !!doc.at(".block-header")
  end


  # Страница со списком товаров
  def self.products?(doc)
    !!doc.at(".b-switcher")
  end
  
  def self.proxy_list
    # http://hidemyass.com/proxy-list/
   list =  %W{
      132.68.237.36:3124   
      163.221.11.73:3124   
      130.136.254.21:3127  
      195.37.16.101:3128   
      143.248.139.171:3124 
      169.229.50.5:3128    
      169.229.50.14:3128   
      169.229.50.10:3128   
      141.24.249.130:3128  
      136.145.115.196:3128 
      133.1.16.172:3128    
      132.239.17.224:3128  
      129.107.35.131:3128  
      128.4.36.11:3128     
      128.31.1.14:3128     
      141.24.33.162:3128   
      128.31.1.15:3128     
      195.113.161.83:3127  
      193.136.191.26:3127  
      193.136.191.25:3127  
      169.229.50.4:3127    
      169.229.50.16:3127   
      152.3.138.2:3127     
      128.232.103.202:3127 
      169.229.50.11:3127   
      193.147.162.166:3124 
      192.42.43.23:3124    
      137.99.11.86:3124    
      132.239.17.225:3124  
      130.92.70.252:3124   
      194.36.10.154:3128   
      206.117.37.4:3128    
      169.229.50.6:3124    
      143.225.229.236:3128 
      194.42.17.124:3128   
      128.227.56.81:3128   
      131.247.2.242:3128   
      203.178.133.2:3124   
      203.178.133.10:3127  
      129.10.120.193:3127  
      194.117.20.215:3127  
      129.10.120.194:3128  
      128.135.11.149:3128  
      204.56.0.138:68660   
      141.76.45.17:3128    
      142.150.238.12:3128  
      137.226.138.154:3128 
      129.107.35.132:3128  
      193.136.227.163:3124 
      142.150.238.13:3124  
      140.114.79.233:3128  
      140.119.164.84:3128  
      192.42.43.22:3128    
      150.65.32.68:3128    
      141.24.33.192:3128   
      194.29.178.14:3128   
      192.33.90.66:3128    
      133.1.74.163:68664   
      192.33.90.68:3128    
      193.136.227.164:3124 
      204.8.155.227:3127   
      192.33.90.69:3127    
      134.226.52.34:3124   
      72.36.112.72:3127    
      128.233.252.11:3127  
      134.34.246.4:3124    
      134.34.246.5:3124    
      202.171.42.7:3128    
      147.83.30.167:3128   
      155.246.12.163:3124  
      155.246.12.164:3124  
      134.151.255.180:3128 
      146.57.249.98:3127   
      207.61.241.100:9090  
      193.191.148.227:3127 
      128.42.142.41:3124   
      128.42.142.42:3124   
      174.142.24.201:3128  
      199.26.254.69:3127   
      221.214.27.252:808   
      62.1.110.245:80      
      201.225.226.68:8080  
      174.142.104.57:3128  
      218.25.99.135:808    
      131.179.50.70:3127   
      146.57.249.99:3128   
      211.138.124.233:80   
      211.138.124.232:80   
      122.205.95.14:80     
      213.131.1.102:3124   
      147.83.30.164:3128   
      211.138.124.211:80   
      80.193.72.145:80     
      211.138.124.210:80   
      143.215.131.198:3124 
      128.112.139.27:3128  
      164.78.252.24:80     
      137.165.1.111:3128   
      211.138.124.196:80   
      210.125.84.17:3124   
      210.123.39.102:3128  
      221.130.13.232:80    
      211.138.124.200:80   
      211.138.124.197:80   
      221.238.17.245:8080  
      221.130.13.225:80    
      211.138.124.198:80   
      129.105.15.37:3127   
      221.130.13.233:80    
      211.138.124.199:80   
      218.201.21.175:80    
      218.201.21.178:80    
      218.201.21.177:80    
      218.201.21.158:80    
      221.214.27.253:808   
      218.201.21.176:80    
      208.67.253.172:80    
      208.67.253.170:80    
      125.64.96.21:8008    
      122.205.95.27:80     
      60.10.164.83:808     
      222.165.133.198:80   
      221.130.7.227:80     
      221.130.7.228:80     
      203.199.50.19:8080   
      221.130.7.226:80     
      221.130.162.249:80   
      194.29.150.140:3128  
      221.130.13.38:80     
      221.130.13.39:80     
      221.130.13.41:80     
      221.130.13.42:80     
      221.130.162.244:80   
      221.130.162.243:80   
      221.130.13.37:80     
      216.48.80.12:3128    
      221.130.162.247:80   
      221.130.162.248:80   
      201.218.246.23:3128  
      125.64.94.68:808     
      221.130.162.245:80   
      128.2.211.114:3124   
      210.245.85.219:8080  
      195.116.53.12:3128   
      221.130.13.228:80    
      211.161.122.10:8080  
      209.107.217.164:80   
      60.190.24.138:80     
      222.89.92.106:3128   
      119.161.149.239:80   
      196.38.158.197:80    
      216.218.211.56:80    
      124.42.10.119:8080   
      61.244.235.34:3128   
      174.142.24.203:3128  
      198.162.52.23:3128   
      212.244.60.45:8080   
      195.244.9.102:8080   
      202.108.50.67:80     
      221.130.7.83:80      
      221.130.7.74:80      
      221.130.7.72:80      
      219.148.202.156:8080 
      174.142.24.202:3128  
      205.213.195.70:8080  
      218.204.29.110:808   
      221.7.159.224:8080   
      174.142.24.206:3128  
      218.69.96.4:80       
      222.77.14.55:80      
      61.180.78.254:8088   
      71.41.204.228:80     
      212.243.72.81:80     
      122.195.141.66:80    
      221.130.7.68:80      
      221.130.7.69:80      
      221.176.88.94:80     
      221.176.88.92:80     
      221.130.7.82:80      
      221.130.13.47:80     
      221.176.88.73:80     
      221.130.7.73:80      
      81.25.54.111:3128    
      218.91.45.90:80      
      121.10.120.214:80    
      221.130.7.76:80      
      222.77.14.56:80      
      222.77.14.54:80      
      213.149.222.230:8080 
      41.190.16.17:8080    
      96.4.198.192:80      
      196.12.187.17:8080   
      213.131.35.59:8080   
      58.246.200.114:80    
      82.147.20.137:80     
      64.71.141.148:3128   
      68.68.107.60:29505   
      174.143.152.14:80    
      70.33.177.129:3128   
      93.190.141.160:3128  
      121.96.26.125:3128   
      218.29.234.50:3128   
      64.79.90.40:808      
      137.195.151.15:80    
      208.188.3.9:3128     
      89.135.53.161:8080   
      72.52.65.4:3128      
      212.99.122.171:8080  
      91.121.208.6:8080    
      203.211.134.235:8370 
      24.111.87.64:8085    
      200.25.177.58:8080   
      82.198.27.146:80     
      79.172.201.152:80    
      89.189.85.118:80     
      217.197.121.188:8080 
      193.200.84.93:80     
      192.193.168.29:8080  
      94.23.236.46:80      
      208.109.168.17:8080  
      90.157.67.237:3128   
      194.15.166.179:80    
      82.160.135.152:8080  
      81.12.224.34:8080          
      116.225.151.192:8088
      123.6.19.97:8088
      173.45.229.206:9090
      189.122.171.234:6588
      189.3.176.130:6588
      189.55.174.28:6588
      195.135.236.204:3128
      200.109.72.53:6588
      200.168.152.152:6588
      200.171.175.157:6588
      200.252.201.144:80
      201.1.63.111:6588
      201.15.218.158:6588
      201.17.163.70:6588
      201.17.188.5:6588
      201.24.125.218:6588
      201.252.211.201:6588
      201.26.8.186:6588
      201.74.205.134:6588
      201.93.128.110:6588
      208.98.17.40:4589
      213.158.112.202:8080
      24.23.29.41:8080
      59.94.38.39:6588
      59.94.41.39:6588
      59.95.205.216:6588
      61.54.82.130:808
      62.193.246.10:6654
      65.75.189.33:9090
      68.207.186.253:9090
      68.81.191.233:9090
      70.176.119.94:9090
      82.239.187.75:21570
      91.188.161.235:3128
      91.203.136.191:80
      97.91.188.113:9090
      119.115.52.109:8088
      121.8.98.90:8888
      123.131.44.66:8088
      124.193.97.60:3128
      128.208.4.197:3124
      128.208.4.199:3124
      146.57.249.98:3128
      160.7.251.98:9090
      189.23.208.37:6588
      189.47.137.189:6588
      189.55.219.176:6588
      189.55.219.252:6588
      189.60.224.13:6588
      190.128.30.14:6588
      190.53.89.103:6588
      200.101.13.202:6588
      200.102.191.228:6588
      200.104.104.91:6588
      200.112.70.53:6588
      200.112.84.5:6588
      200.120.224.207:6588
      200.158.26.223:6588
      200.159.216.247:6588
      200.161.31.11:6588
      200.171.17.23:6588
      200.171.232.140:6588
      201.10.42.166:6588
      201.12.116.112:6588
      201.15.143.25:6588
      201.15.30.1:6588
      201.229.208.3:80
      201.246.116.96:6588
      201.53.73.44:6588
      201.66.27.218:6588
      201.75.78.76:6588
      201.86.70.162:80
      203.124.21.224:6588
      203.86.31.92:3128
      207.161.20.188:9090
      208.53.196.161:9090
      209.159.228.202:9090
      209.218.218.171:9090
      211.140.151.214:8080
      218.248.20.160:6588
      220.224.226.149:3128
      24.127.113.227:9090
      24.14.112.139:9090
      24.153.249.240:9090
      24.189.5.235:9090
      24.22.86.147:9090
      24.230.182.225:9090
      24.98.81.111:9090
      59.92.3.208:6588
      59.94.177.245:6588
      60.49.51.63:6588
      62.168.174.254:3128
      67.149.215.109:9090
      67.168.222.227:9090
      67.182.204.248:9090
      67.188.156.177:9090
      67.87.64.23:9090
      68.10.87.155:9090
      68.102.90.174:2301
      68.11.145.150:9090
      68.11.182.166:9090
      68.11.237.184:9090
      68.13.220.63:9090
      68.198.151.89:9090
      68.199.107.24:9090
      68.229.158.96:9090
      68.45.42.160:9090
      68.60.189.199:9090
      68.63.48.36:9090
      68.8.224.217:9090
      68.83.156.112:9090
      68.9.242.26:9090
      68.97.121.200:9090
      68.98.0.233:9090
      69.118.237.19:9090
      69.136.70.21:9090
      69.180.8.201:9090
      69.246.123.26:9090
      69.246.45.182:9090
      69.246.61.14:9090
      70.177.53.179:9090
      70.95.110.195:9090
      71.14.95.198:9090
      71.192.234.31:9090
      71.205.238.236:9090
      71.207.56.148:9090
      71.229.16.100:9090
      71.80.99.54:7212
      72.55.191.6:3128
      75.87.189.110:9090
      76.106.127.211:9090
      76.107.44.181:9090
      76.113.8.160:9090
      76.116.82.97:9090
      76.27.54.31:9090
      76.28.1.186:9090
      76.29.10.61:11055
      76.89.23.238:9090
      80.0.76.158:9090
      82.13.85.245:9090
      82.28.185.247:9090
      82.38.36.40:9090
      82.9.52.183:9090
      83.167.122.41:3128
      83.220.195.232:9090
      86.21.200.186:9090
      86.22.7.232:9090
      87.120.67.39:6588
      88.171.218.44:9090
      88.173.201.9:21570
      90.188.254.197:3128
      91.78.100.114:38392
      92.237.9.240:9090
      96.28.116.40:9090
      96.28.160.240:9090
      96.3.152.82:9090
      98.202.107.151:9090
      98.240.186.255:9090
      98.244.161.239:9090
      99.155.153.203:9090
      142.59.52.201:9090
      157.182.52.224:9090
      189.20.207.150:8080
      190.152.37.58:6588
      198.164.83.28:9090
      201.13.169.167:6588
      201.14.225.222:6588
      201.229.208.2:80
      201.252.106.88:6588
      201.255.178.224:6588
      201.26.19.180:6588
      201.3.184.222:6588
      201.42.69.73:6588
      201.45.188.169:6588
      201.68.18.124:6588
      201.75.20.103:6588
      201.76.29.82:6588
      201.88.248.243:6588
      202.134.202.251:80
      203.110.240.22:80
      204.111.219.182:9090
      204.85.72.128:9090
      206.174.3.131:9090
      207.38.251.111:9090
      208.107.124.142:9090
      209.145.114.173:9090
      209.159.241.112:9090
      210.52.15.210:808
      211.90.22.106:8088
      212.17.86.109:8080
      216.80.118.13:9090
      218.75.23.110:3128
      218.97.194.94:80
      221.224.95.158:808
      24.10.186.31:9090
      24.10.84.226:9090
      24.12.214.237:9090
      24.137.215.227:9090
      24.156.135.87:9090
      24.161.131.67:9090
      24.167.83.34:9090
      24.174.246.62:9090
      24.185.121.80:9090
      24.188.121.167:9090
      24.188.125.225:9090
      24.192.240.240:9090
      24.217.194.73:9090
      24.228.49.186:9090
      24.23.182.99:9090
      24.3.105.116:9090
      24.30.90.20:9090
      24.4.239.144:9090
      24.8.191.246:9090
      24.9.22.230:9090
      24.98.204.26:9090
      58.8.150.146:6588
      59.56.174.199:808
      61.175.226.78:808
      61.187.187.28:80
      61.238.104.200:808
      62.168.173.33:3128
      64.17.66.234:9090
      65.30.92.48:9090
      66.167.228.62:9090
      66.214.17.189:9090
      66.229.205.251:9090
      66.41.189.96:9090
      66.57.75.68:9090
      67.163.161.226:9090
      67.191.141.209:9090
      67.191.220.137:9090
      67.48.22.73:9090
      67.84.115.34:9090
      67.84.84.89:9090
      67.9.20.215:9090
      68.105.0.173:9090
      68.105.12.164:9090
      68.11.226.141:9090
      68.11.249.230:9090
      68.227.129.204:9090
      68.228.236.251:9090
      68.62.176.8:9090
      68.84.126.225:9090
      69.113.232.218:9090
      69.114.237.205:9090
      69.116.42.119:9090
      69.123.44.118:9090
      69.127.115.255:9090
      69.136.136.125:9090
      69.136.58.38:9090
      69.138.46.194:9090
      69.161.78.160:9090
      69.242.176.42:9090
      69.245.52.76:9090
      69.246.117.136:9090
      69.249.151.19:9090
      69.253.188.82:9090
      69.71.85.202:9090
      70.125.110.220:9090
      70.161.20.242:9090
      70.172.242.76:9090
      70.186.168.130:9090
      70.186.174.186:9090
      70.238.144.197:9090
      70.74.213.38:9090
      71.178.155.167:9090
      71.192.233.196:9090
      71.194.0.41:9090
      71.194.217.243:9090
      71.197.189.88:9090
      71.205.102.196:9090
      71.205.238.140:9090
      71.205.37.198:9090
      71.224.107.188:9090
      71.224.87.71:9090
      71.237.41.13:9090
      71.8.98.36:9090
      71.86.150.78:9090
      71.90.230.116:9090
      72.196.135.11:9090
      74.15.86.86:9090
      75.180.26.184:9090
      75.183.7.150:9090
      75.65.64.163:9090
      75.81.22.134:9090
      75.83.57.219:9090
      76.102.95.54:9090
      76.107.208.13:9090
      76.107.42.95:9090
      76.110.138.122:9090
      76.110.211.162:9090
      76.112.150.1:9090
      76.112.25.186:9090
      76.123.18.157:9090
      76.127.22.84:9090
      76.170.85.232:9090
      76.173.155.23:9090
      77.100.241.213:9090
      80.143.220.5:8080
      80.195.248.30:9090
      80.4.60.88:9090
      81.101.145.245:9090
      82.238.32.72:14848
      82.41.198.251:9090
      82.41.56.62:9090
      82.43.58.68:9090
      82.45.110.245:9090
      82.46.44.15:9090
      82.7.105.26:9090
      84.198.202.74:9090
      85.168.233.221:9090
      86.0.224.116:9090
      86.12.7.19:9090
      87.116.164.85:6588
      88.113.14.234:3128
      89.241.213.95:9090
      89.29.195.27:8080
      92.234.144.16:9090
      92.236.16.51:9090
      92.236.26.72:9090
      92.9.76.236:9090
      96.3.172.29:9090
      97.85.152.126:9090
      98.141.23.139:9090
      98.155.147.62:9090
      98.163.204.145:9090
      98.169.171.231:9090
      98.192.95.181:9090
      98.208.46.176:9090
      98.223.204.15:9090
      99.225.136.21:9090
      12.13.94.227:9090
      12.208.168.97:9090
      12.208.190.71:9090
      12.51.72.38:9090
      156.34.176.45:9090
      194.46.229.3:9090
      195.24.131.87:3128
      200.102.217.207:6588
      200.161.118.198:6588
      200.207.48.252:8080
      201.1.113.10:6588
      201.13.187.229:6588
      201.59.184.124:6588
      201.80.207.132:6588
      202.194.133.31:808
      202.78.225.1:8090
      202.98.141.200:808
      203.129.53.177:9090
      207.50.148.37:9090
      208.53.199.75:9090
      210.245.63.218:80
      210.34.14.166:81
      213.55.87.105:6588
      218.206.194.247:8800
      218.75.76.74:8088
      222.73.205.27:808
      24.11.124.76:9090
      24.139.68.242:9090
      24.170.82.144:9090
      24.188.251.54:9090
      24.190.104.34:9090
      24.205.202.45:9090
      24.23.199.14:9090
      24.254.34.183:9090
      24.44.219.167:9090
      24.59.34.24:9090
      24.70.39.70:9090
      64.179.170.189:9090
      64.30.123.252:9090
      65.28.107.26:9090
      65.28.8.13:9090
      65.29.85.76:9090
      66.177.219.202:9090
      66.25.114.65:9090
      66.91.101.52:9090
      67.149.165.201:9090
      67.65.242.94:9090
      67.84.148.144:9090
      67.9.255.2:9090
      68.104.55.221:9090
      68.113.102.37:9090
      68.117.211.122:9090
      68.118.245.35:9090
      68.144.70.254:9090
      68.198.72.147:9090
      68.201.46.56:9090
      68.205.170.214:9090
      68.59.217.62:9090
      68.60.168.230:9090
      69.127.102.247:9090
      69.127.175.231:9090
      69.180.245.32:9090
      69.181.89.167:9090
      69.47.174.178:9090
      71.205.107.223:9090
      71.237.98.13:9090
      72.128.40.214:9090
      72.141.35.81:9090
      72.174.123.174:9090
      72.178.248.236:9090
      72.190.122.130:9090
      72.197.212.200:7212
      72.203.130.111:9090
      74.131.139.186:9090
      74.171.2.153:9090
      75.85.136.141:9090
      75.87.150.14:9090
      75.93.212.146:9090
      76.244.189.250:9090
      77.101.103.239:9090
      77.103.254.43:9090
      77.99.162.166:9090
      82.12.101.34:9090
      82.234.51.250:9090
      82.24.250.31:9090
      82.32.221.58:9090
      82.36.86.70:9090
      82.40.48.179:9090
      82.41.21.126:9090
      82.43.63.99:9090
      82.45.117.238:9090
      83.36.162.217:9090
      85.134.160.128:9090
      86.10.109.253:9090
      86.11.208.239:9090
      88.172.20.212:11033
      88.174.252.233:11011
      91.110.151.89:9090
      92.236.137.151:9090
      92.237.70.251:9090
      96.21.139.56:9090
      98.197.219.216:9090
      98.206.20.88:9090
      98.210.139.101:9090
      98.28.33.20:9090
      99.199.237.158:9090
      99.247.210.73:9090
      116.48.224.179:9090
      201.68.227.8:6588
      209.124.242.193:9090
      216.228.57.247:9090
      218.252.37.227:808
      24.175.116.55:9090
      24.254.113.238:9090
      24.67.14.108:9090
      24.77.22.225:9090
      65.28.103.187:9090
      66.67.106.227:9090
      69.151.73.128:9090
      69.71.95.69:9090
      71.10.72.221:9090
      72.174.161.51:9090
      72.24.212.232:9090
      74.129.180.10:9090
      75.179.140.16:9090
      76.105.105.96:9090
      76.107.137.6:9090
      76.69.32.139:9090
      77.99.30.244:9090
      78.162.45.2:8080
      81.101.146.0:9090
      82.158.219.108:6588
      82.3.162.235:9090
      82.34.224.141:9090
      82.40.28.187:9090
      82.44.34.27:9090
      84.198.148.132:9090
      86.15.193.138:9090
      86.42.180.157:9090
      88.165.169.130:9090
      92.236.222.129:9090
      92.238.25.211:9090
      99.232.189.8:9090
      99.242.140.117:9090
      99.254.203.191:9090
      194.117.157.72:11251
      200.204.235.123:6588
      201.13.176.9:6588
      201.26.133.204:8080
      207.181.207.36:9090
      209.145.101.201:3128
      209.159.184.219:9090
      24.14.107.77:9090
      24.154.129.8:9090
      24.2.69.26:9090
      24.211.49.0:9090
      61.234.254.69:8088
      65.190.207.153:9090
      69.88.35.197:9090
      72.207.200.241:9090
      74.193.33.187:9090
      76.183.112.143:9090
      76.214.55.31:9090
      77.103.153.29:9090
      77.99.11.82:9090
      78.224.128.22:80
      81.96.127.75:9090
      82.22.138.43:9090
      82.41.57.26:9090
      82.45.253.25:9090
      86.61.76.7:8088
      90.199.136.7:9090
      92.235.253.182:9090
      92.238.40.83:9090
      97.87.65.118:9090
      97.97.255.95:9090
      98.16.253.47:8080
      189.79.63.28:6588
      200.119.56.48:6588
      200.21.24.79:6588
      201.253.144.1:8080
      61.144.109.96:8080
      66.253.168.169:9090
      66.38.121.88:9090
      76.173.95.124:9090
      77.100.110.112:9090
      77.103.130.91:9090
      77.96.143.223:9090
      78.43.175.129:9090
      80.192.214.147:9090
      80.193.158.197:9090
      82.24.15.141:9090
      82.33.168.194:9090
      82.41.10.6:9090
      82.46.144.165:9090
      86.46.156.172:9090
      88.104.209.63:9090
      124.53.159.169:80
      130.63.177.192:8080
      200.217.53.234:6588
      201.26.212.10:6588
      207.192.207.240:9090
      216.119.183.110:9090
      24.208.37.143:9090
      24.78.169.73:9090
      71.205.109.70:9090
      76.107.108.144:9090
      76.187.117.138:9090
      77.101.103.91:9090
      77.96.105.84:9090
      80.4.59.69:9090
      82.0.100.211:9090
      82.154.126.143:6588
      82.33.117.189:9090
      82.6.69.14:9090
      83.70.106.206:9090
      84.194.92.1:9090
      92.233.3.150:9090
      99.237.129.44:9090
      99.254.157.217:9090
      122.107.124.56:9090
      125.40.59.193:8080
      189.111.166.103:6588
      193.69.186.83:80
      218.229.29.128:8080
      58.83.197.27:8080
      68.201.24.46:9090
      70.76.83.81:9090
      75.184.41.3:9090
      80.193.189.226:9090
      82.12.118.67:9090
      82.45.59.203:9090
      86.12.57.51:9090
      86.24.213.144:9090
      92.233.226.34:9090
      92.236.18.113:9090
      98.165.245.250:9090
      116.5.232.33:8088
      189.19.168.149:6588
      190.139.49.20:8090
      201.68.77.129:6588
      61.159.214.215:808
      80.192.75.52:9090
      99.228.104.199:9090
      123.127.110.247:80
      129.93.193.140:9090
      195.3.150.187:3128
      67.80.81.65:9090
      125.34.30.201:8080
      200.232.184.253:6588
      92.236.102.208:9090
      213.231.139.130:808
      67.49.162.117:9090
      67.82.22.33:9090
      91.147.97.179:3128
      67.49.150.210:9090
      115.99.10.9:6588
      67.81.235.37:9090
      12.240.37.195:9090
      68.111.231.178:9090
      68.42.247.66:9090
      218.248.31.212:6588
      124.207.168.48:808
      216.117.225.240:9090
      68.84.47.147:9090
      122.6.245.14:8090
      68.55.225.102:9090
      92.233.166.55:9090
      128.208.4.199:3127
      69.142.108.83:9090
      92.239.120.214:9090
      140.113.156.245:3128
      174.0.50.242:9090
      69.122.222.90:9090
      163.30.32.90:80
      69.254.246.123:9090
      69.246.218.125:9090
      70.119.146.106:9090
      70.127.205.107:9090
      142.59.90.148:9090
      69.250.8.55:9090
      189.19.10.23:6588
      189.29.117.58:6588
      70.86.138.210:8131
      70.180.62.153:9090
      70.180.206.70:9090
      189.19.60.123:6588
      187.11.250.36:6588
      69.46.16.232:34311
      70.64.225.85:9090
      71.200.233.55:9090
      70.64.250.176:9090
      71.205.113.223:9090
      24.108.35.246:7212
      194.117.157.72:16727
      24.118.147.89:9090
      24.12.3.143:9090
      71.61.176.210:3128
      24.151.126.249:9090
      72.137.122.212:9090
      71.85.121.118:9090
      72.207.59.75:9090
      72.227.236.241:9090
      72.227.36.24:9090
      71.82.77.13:9090
      71.89.55.232:9090
      74.197.219.75:9090
      74.77.117.65:9090
      24.13.108.167:9090
      24.230.163.136:9090
      24.20.45.101:9090
      74.210.84.24:9090
      74.141.111.159:9090
      24.61.52.46:9090
      72.222.172.142:9090
      24.197.130.9:9090
      24.85.205.35:9090
      24.83.40.206:9090
      76.110.119.179:9090
      75.94.80.132:9090
      98.181.60.131:9090
      76.115.37.7:9090
      75.64.35.123:9090
      76.107.151.18:9090
      200.187.136.122:6588
      200.61.19.208:6588
      76.28.208.70:9090
      76.107.38.217:9090
      76.247.168.177:9090
      200.3.252.170:3128
      59.177.176.21:8088
      59.37.166.56:3128
      76.28.250.36:9090
      76.176.208.180:9090
      76.22.128.2:9090
      76.9.42.163:9090
      60.28.209.8:80
      77.99.113.100:9090
      61.153.140.106:808
      77.97.103.232:9090
      77.99.183.136:9090
      78.138.131.150:8080
      98.210.147.111:9090
      81.98.109.201:9090
      62.119.28.242:80
      64.111.32.54:9090
      64.83.209.110:9090
      81.97.147.154:9090
      82.21.184.178:9090
      82.33.67.71:9090
      82.37.169.145:9090
      82.41.5.12:9090
      82.40.215.66:9090
      82.42.57.203:9090
      65.30.216.140:9090
      82.33.46.103:9090
      66.199.247.42:6649
      66.57.230.14:9090
      82.35.201.216:9090
      82.47.59.57:9090
      66.57.1.142:9090
      82.46.169.181:9090
      209.159.204.250:9090
      208.53.199.48:9090
      83.85.27.225:9090
      86.4.25.128:9090
      85.24.89.199:6588
      99.232.137.243:9090
      86.9.124.75:9090
      86.2.31.207:9090
      88.183.152.141:11011
      99.253.188.98:9090
    }
    res = list[rand(list.size)]
    puts "PROXY = #{res}"
    res
  end


  #### ИЗВЛЕЧЕНИЕ ДАННЫХ СО СТРАНИЦЫ ТОВАРА

  # парсилка характеристик со страницы товара
  def parse_characteristics(doc)
    res = Array.new()
    doc.search('table.modelProperties').each do |table|
      table.search('tr').each do |tr|
        if tr.at('td.label')
          res << Hash[*(tr.search('td').collect{|td| td.inner_text})]
        end
      end
    end
    res
  end

end